.text
.globl main

main:
    # Load base addresses
    la   $s3, A          # base A
    la   $s4, B          # base B
    la   $s5, C          # base C
    la   $s6, MAX        # base MAX
    la   $s7, MIN        # base MIN

    # Load N
    la   $t9, N
    lw   $s0, 0($t9)     # s0 = N

    li   $s1, 0          # i = 0

##################################################
#  Outer loop: for (i = 0; i < N; i++)
##################################################
outer_loop:
    slt  $t0, $s1, $s0       # t0 = (i < N)
    li   $s2, 0              # j = 0
    beq  $t0, $zero, end_i
    nop                      # delay slot

    # limit = N-3
    addiu $t6, $s0, -3       # t6 = N - 3

##################################################
#  Inner loop: unrolled ×4
##################################################
unroll_loop:
    slt  $t0, $s2, $t6       # (j < N-3) ?
    mul  $t1, $s1, $s0       # delay slot: t1 = i * N
    beq  $t0, $zero, tail_loop
   

    # offset = (i*N + j) * 4
    add  $t5, $t1, $s2
    sll  $t5, $t5, 2

    # ----------------------------------------------------
    # ΣΤΟΙΧΕΙΟ 1
    # ----------------------------------------------------
    # Load A, B, C
    addu $t7, $s3, $t5
    lw   $t0, 0($t7)         # t0 = A
    addu $t7, $s4, $t5
    lw   $t1, 0($t7)         # t1 = B
    addu $t7, $s5, $t5
    lw   $t2, 0($t7)         # t2 = C

    # --- MAX Calculation (A, B) ---
    slt  $t8, $t0, $t1       # A < B
    sub  $t9, $t1, $t0       # B - A
    sub  $t8, $zero, $t8     # mask
    and  $t9, $t9, $t8
    add  $t3, $t0, $t9       # t3 = max(A,B)

    # --- MIN Calculation (A, B) ---
    # Logic: Start with B. If A < B, add (A-B) to make it A.
    slt  $t8, $t0, $t1       # A < B
    sub  $t9, $t0, $t1       # A - B
    sub  $t8, $zero, $t8     # mask
    and  $t9, $t9, $t8
    add  $t4, $t1, $t9       # t4 = min(A,B)

    # --- MAX with C ---
    slt  $t8, $t3, $t2       # max < C
    sub  $t9, $t2, $t3       # C - max
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t3, $t9       # t3 = max(A,B,C)

    # --- MIN with C  ---
    # Logic: Start with min. If C < min, add (C-min) to make it C.
    slt  $t8, $t2, $t4       # C < min
    sub  $t9, $t2, $t4       # C - min
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t4, $t9       # t4 = min(A,B,C)

    # Store
    addu $t7, $s6, $t5
    sw   $t3, 0($t7)         # Store MAX
    addu $t7, $s7, $t5
    sw   $t4, 0($t7)         # Store MIN

    # ----------------------------------------------------
    # ΣΤΟΙΧΕΙΟ 2
    # ----------------------------------------------------
    addi $t5, $t5, 4
    addu $t7, $s3, $t5
    lw   $t0, 0($t7)
    addu $t7, $s4, $t5
    lw   $t1, 0($t7)
    addu $t7, $s5, $t5
    lw   $t2, 0($t7)

    # Max
    slt  $t8, $t0, $t1
    sub  $t9, $t1, $t0
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t0, $t9
    # Min 
    slt  $t8, $t0, $t1
    sub  $t9, $t0, $t1
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t1, $t9

    # Max w/ C
    slt  $t8, $t3, $t2
    sub  $t9, $t2, $t3
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t3, $t9
    # Min w/ C 
    slt  $t8, $t2, $t4
    sub  $t9, $t2, $t4
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t4, $t9

    # Store
    addu $t7, $s6, $t5
    sw   $t3, 0($t7)
    addu $t7, $s7, $t5
    sw   $t4, 0($t7)

    # ----------------------------------------------------
    # ΣΤΟΙΧΕΙΟ 3
    # ----------------------------------------------------
    addi $t5, $t5, 4
    addu $t7, $s3, $t5
    lw   $t0, 0($t7)
    addu $t7, $s4, $t5
    lw   $t1, 0($t7)
    addu $t7, $s5, $t5
    lw   $t2, 0($t7)

    # Max
    slt  $t8, $t0, $t1
    sub  $t9, $t1, $t0
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t0, $t9
    # Min 
    slt  $t8, $t0, $t1
    sub  $t9, $t0, $t1
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t1, $t9

    # Max w/ C
    slt  $t8, $t3, $t2
    sub  $t9, $t2, $t3
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t3, $t9
    # Min w/ C 
    slt  $t8, $t2, $t4
    sub  $t9, $t2, $t4
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t4, $t9

    # Store
    addu $t7, $s6, $t5
    sw   $t3, 0($t7)
    addu $t7, $s7, $t5
    sw   $t4, 0($t7)

    # ----------------------------------------------------
    # ΣΤΟΙΧΕΙΟ 4
    # ----------------------------------------------------
    addi $t5, $t5, 4
    addu $t7, $s3, $t5
    lw   $t0, 0($t7)
    addu $t7, $s4, $t5
    lw   $t1, 0($t7)
    addu $t7, $s5, $t5
    lw   $t2, 0($t7)

    # Max
    slt  $t8, $t0, $t1
    sub  $t9, $t1, $t0
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t0, $t9
    # Min 
    slt  $t8, $t0, $t1
    sub  $t9, $t0, $t1
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t1, $t9

    # Max w/ C
    slt  $t8, $t3, $t2
    sub  $t9, $t2, $t3
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t3, $t9
    # Min w/ C 
    slt  $t8, $t2, $t4
    sub  $t9, $t2, $t4
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t4, $t9

    # Store
    addu $t7, $s6, $t5
    sw   $t3, 0($t7)
    addu $t7, $s7, $t5
    sw   $t4, 0($t7)

    addi $s2, $s2, 4
    j    unroll_loop
    nop

##################################################
# Tail loop
##################################################
tail_loop:
    slt  $t0, $s2, $s0
    mul  $t1, $s1, $s0
    beq  $t0, $zero, end_j
    
    
    add  $t5, $t1, $s2
    sll  $t5, $t5, 2

    addu $t7, $s3, $t5
    lw   $t0, 0($t7)
    addu $t7, $s4, $t5
    lw   $t1, 0($t7)
    addu $t7, $s5, $t5
    lw   $t2, 0($t7)

    # Max
    slt  $t8, $t0, $t1
    sub  $t9, $t1, $t0
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t0, $t9
    # Min [Fix]
    slt  $t8, $t0, $t1
    sub  $t9, $t0, $t1
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t1, $t9

    # Max w/ C
    slt  $t8, $t3, $t2
    sub  $t9, $t2, $t3
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t3, $t3, $t9
    # Min w/ C 
    slt  $t8, $t2, $t4
    sub  $t9, $t2, $t4
    sub  $t8, $zero, $t8
    and  $t9, $t9, $t8
    add  $t4, $t4, $t9

    # Store
    addu $t7, $s6, $t5
    sw   $t3, 0($t7)
    addu $t7, $s7, $t5
    sw   $t4, 0($t7)

    addi $s2, $s2, 1
    j    tail_loop
    nop

end_j:
    addi $s1, $s1, 1
    j    outer_loop
    nop

end_i:
    break

##################################################
# ΔΕΔΟΜΕΝΑ (Data)
##################################################
.data
.org 0x0
A:
.word 12,5,9,7,3,18,20,4,2,15,8,11,6,14,1,10
.word 7,3,14,8,22,1,9,17,5,12,6,4,19,2,11,10
.word 2,18,6,14,9,3,10,21,13,7,5,8,4,11,1,16
.word 9,1,15,3,12,6,20,7,2,14,8,19,5,10,4,11
.word 3,8,11,4,6,15,1,9,20,2,13,5,7,18,10,14
.word 13,7,2,6,10,4,11,15,19,1,9,8,3,16,5,12
.word 4,9,12,1,5,7,14,3,10,6,8,2,13,11,16,15
.word 6,14,3,12,2,5,8,10,1,13,7,4,9,15,11,16
.word 8,10,1,5,3,12,7,6,4,14,2,11,13,9,16,15
.word 5,11,9,2,8,13,6,3,12,7,14,1,10,4,15,16
.word 10,4,7,14,1,9,3,8,5,12,6,11,2,15,13,16
.word 3,6,12,5,7,2,14,9,1,10,4,8,13,11,15,16
.word 1,15,8,11,6,4,9,7,2,13,5,12,10,14,3,16
.word 7,2,10,6,15,3,8,11,4,9,1,14,5,13,12,16
.word 9,5,13,7,2,10,6,3,12,15,8,11,4,14,1,16
.word 4,8,6,1,9,14,2,5,10,7,3,12,11,13,15,16

B:
.word 4,18,2,11,6,13,9,14,1,12,7,3,16,5,10,8
.word 9,6,13,5,2,8,14,11,7,3,10,4,12,1,16,15
.word 5,1,8,3,14,9,6,12,15,4,7,2,10,13,11,16
.word 7,3,12,9,15,6,4,10,2,8,11,5,13,1,16,14
.word 6,2,9,12,4,7,1,15,10,3,8,11,14,5,13,16
.word 11,5,3,8,13,7,2,10,4,12,9,6,14,1,16,15
.word 10,7,6,1,5,9,4,8,12,2,11,3,16,14,13,15
.word 8,14,3,6,9,12,5,7,4,11,10,1,13,2,16,15
.word 12,4,10,3,7,1,6,9,5,13,8,2,14,11,15,16
.word 3,6,14,8,2,9,5,12,1,4,11,10,7,13,16,15
.word 1,9,4,7,6,12,8,11,2,10,3,15,5,13,14,16
.word 13,8,6,4,11,3,7,2,9,5,14,12,1,15,16,10
.word 15,10,5,12,3,8,6,14,1,11,7,9,4,16,13,2
.word 9,4,11,6,10,2,8,12,3,15,1,5,7,13,14,16
.word 5,12,7,3,14,4,9,10,8,6,2,11,1,13,16,15
.word 2,8,13,5,1,9,3,11,7,10,4,6,15,12,14,16

C:
.word 15,3,11,8,2,5,9,1,6,12,4,14,10,7,13,16
.word 6,14,2,9,3,11,4,15,10,7,1,12,8,5,13,16
.word 7,4,9,2,12,6,3,14,8,1,5,11,13,10,15,16
.word 10,6,3,5,8,2,9,12,11,14,7,1,4,13,15,16
.word 8,1,12,3,7,5,2,10,6,11,9,13,14,4,15,16
.word 5,6,14,1,3,12,8,7,10,2,9,4,11,13,16,15
.word 11,3,5,8,14,9,6,1,4,7,2,10,15,13,12,16
.word 2,9,6,4,1,13,8,7,12,5,10,11,3,15,14,16
.word 9,4,7,2,6,10,5,8,11,3,12,1,14,15,16,13
.word 3,10,8,5,12,6,7,14,1,4,9,11,2,16,15,13
.word 1,12,14,7,9,4,11,3,8,2,6,10,5,13,15,16
.word 4,6,5,3,8,12,7,10,1,11,14,9,15,16,13,2
.word 6,8,10,12,5,11,3,9,4,14,7,2,15,16,13,1
.word 8,7,4,6,11,9,12,2,5,3,10,13,14,15,16,1
.word 7,5,11,8,10,3,15,6,12,9,4,14,1,13,16,2
.word 3,14,6,1,2,15,4,10,8,7,13,11,5,12,16,9

MAX: .space 1024
MIN: .space 1024
N:   .word 16